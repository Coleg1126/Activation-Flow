<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vivint Guided Setup</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background:#0b0f14; color:#e8eef6; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 18px; }
    .grid { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 14px; }
    .card { background:#121a24; border:1px solid #1e2a3a; border-radius: 14px; padding: 14px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    h1 { font-size: 18px; margin: 0 0 10px; }
    h2 { font-size: 14px; margin: 0 0 10px; color:#b9c7d8; }
    .row { display:flex; gap:10px; flex-wrap: wrap; align-items: center; }
    button, select, input, textarea {
      background:#0f1722; color:#e8eef6; border:1px solid #273549;
      border-radius: 12px; padding: 12px 14px; font-size: 15px;
    }
    button { cursor:pointer; }
    button.primary { background:#1a3a66; border-color:#2b4d7a; }
    button.danger { background:#5a1d1d; border-color:#7a2b2b; }
    button.ghost { background:transparent; }
    button:disabled { opacity: .45; cursor:not-allowed; }
    .pill { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid #273549; background:#0f1722; color:#b9c7d8; }
    .muted { color:#9fb0c6; }
    .divider { height:1px; background:#1e2a3a; margin: 12px 0; }
    .menu { display:none; margin-top: 10px; }
    .menu.open { display:block; }
    .menu button { width:100%; text-align:left; margin-bottom: 8px; }
    .status { font-size: 12px; color:#9fb0c6; }
    .big { font-size: 15px; line-height: 1.5; white-space: pre-wrap; }
    .alert { border: 1px solid #7a2b2b; background: rgba(122,43,43,.18); padding: 10px 12px; border-radius: 12px; }
    .ok { border: 1px solid #2b7a52; background: rgba(43,122,82,.16); padding: 10px 12px; border-radius: 12px; }
    .small { font-size: 12px; }
    .rightcol textarea { min-height: 190px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; }

    /* Loading overlay */
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index: 9999; backdrop-filter: blur(2px); }
    .overlay.open { display:flex; }
    .loaderCard { width: min(420px, 92vw); background:#121a24; border:1px solid #273549; border-radius: 16px; padding: 18px; box-shadow: 0 14px 40px rgba(0,0,0,.5); display:flex; gap:14px; align-items:center; }
    .spinner { width: 26px; height: 26px; border-radius: 999px; border: 3px solid rgba(255,255,255,.18); border-top-color: rgba(255,255,255,.9); animation: spin .8s linear infinite; flex: 0 0 auto; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* CUSTOMER MODE (prefilled link): hide right panel, show CSID only */
    .csidOnlyWrap { display:none; }
    .customerMode .grid { grid-template-columns: 1fr; }
    .customerMode #rightCard { display:none; }
    .customerMode .csidOnlyWrap { display:block; margin-top:10px; }

    /* Mobile layout */
    @media (max-width: 900px) {
      .wrap { padding: 12px; }
      .grid { grid-template-columns: 1fr; }
      .row.actions button { width: 100%; }
      .row.topbar { align-items:flex-start; }
      button, select, input, textarea { width: 100%; box-sizing: border-box; }
      .pill { width: 100%; box-sizing: border-box; justify-content: space-between; }
      .row { gap: 10px; }
      .row.compact { flex-direction: column; align-items: stretch; }
      .menu button { padding: 14px; }
    }
  </style>
</head>

<body>
  <div class="overlay" id="overlay">
    <div class="loaderCard">
      <div class="spinner"></div>
      <div>
        <div style="font-weight:600;">One moment‚Ä¶</div>
        <div class="muted small">Preparing the next message.</div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="row topbar" style="justify-content: space-between;">
      <h1>Vivint Guided Setup</h1>
      <div class="row compact">
        <span class="pill">Panel: <strong id="panelPill">Not set</strong></span>
        <span class="pill">Step: <strong id="stepPill">‚Äî</strong></span>
        <button class="ghost" id="resetBtn">Reset</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <h2>Message</h2>
        <div id="botMessage" class="big"></div>

        <!-- CSID-only display (visible in customer mode) -->
        <div class="csidOnlyWrap" id="csidOnlyWrap">
          <div class="divider"></div>
          <div class="row compact">
            <span class="pill">CSID: <strong id="csidOnlyText">‚Äî</strong></span>
            <button id="copyCsidBtn">üìã Copy CSID</button>
          </div>
          <div class="muted small">If the monitoring station asks, share this CSID.</div>
        </div>

        <div class="divider"></div>

        <div class="row actions">
          <button class="primary" id="doneBtn">‚úÖ Done</button>
          <button id="issuesBtn">‚ö†Ô∏è I‚Äôm having an issue</button>
          <button id="lostBtn">üß≠ I can‚Äôt find that screen</button>
          <button class="danger" id="escalateBtn">üö® I need help from a person</button>
        </div>

        <div id="issuesMenu" class="menu"></div>

        <div class="divider"></div>
        <div class="row compact">
          <button id="copyBtn">üìã Copy message</button>
          <button id="backBtn">‚¨ÖÔ∏è Back one step</button>
          <span class="status" id="statusLine"></span>
        </div>

        <div id="helperPanel" style="margin-top:12px;"></div>
      </div>

      <!-- RIGHT (hidden in customer mode) -->
      <div class="card rightcol" id="rightCard">
        <h2>Setup Details (Agent)</h2>

        <div class="row compact">
          <label class="pill">
            Panel type:
            <select id="panelSelect">
              <option value="">Select‚Ä¶</option>
              <option value="smarthub">SmartHub</option>
              <option value="skycontrol">SkyControl</option>
            </select>
          </label>
        </div>

        <div class="divider"></div>

        <h2>Information</h2>
        <div class="row compact">
          <label class="pill">CSID: <input id="csid" placeholder="EZ123456" /></label>
          <label class="pill">Registration code: <input id="reg" placeholder="ABCD-EFGH-IJKL-LMNO" /></label>
        </div>
        <div class="row compact">
          <label class="pill">Service # (top-right): <input id="serviceNum" placeholder="Service number‚Ä¶" /></label>
        </div>

        <div class="divider"></div>

        <h2>Escalation message</h2>
        <textarea id="escalationText" class="mono"></textarea>
        <div class="row compact">
          <button id="copyEscBtn">üìã Copy escalation</button>
        </div>

        <div class="divider"></div>

        <h2>Share</h2>
        <div class="row compact">
          <button class="primary" id="makeLinkBtn">üîó Generate customer link</button>
          <button id="copyLinkBtn" disabled>üìã Copy link</button>
        </div>
        <div class="row compact" style="width:100%;">
          <input id="shareLink" style="width:100%;" placeholder="Link will appear here‚Ä¶" readonly />
        </div>
        <div class="muted small" style="margin-top:6px;">
          Tip: Uses a hash-link so values are not typically sent as referrer data.
        </div>
      </div>
    </div>
  </div>

  <script>
    /**
     * Updates in this version:
     * - "Lost" no longer shows screen choices. It shows a step-specific "get back to it" guide.
     * - After "I have an issue" troubleshooting, customer should tap DONE to return to the original step message.
     * - "Need help from a person" now shows: To chat with a representative, text (385) 425-0752
     */

    const STORAGE_KEY = "vivint_activation_flow_customer_v5";
    let isCustomerMode = false;

    /** ====== Core flow model (starts at step_1) ====== */
    function stripDashes(code) { return (code || "").replace(/-/g, ""); }

    const FLOW = {
      steps: [
        {
          id: "step_1",
          name: "Main screen check",
          message: () => `Please verify:
1) The panel is powered on
2) The date and time (top-left) look correct

When that‚Äôs done, tap Done.`,
          ui: {
            issues: [
              { id: "panel_not_on", label: "The panel is not on / screen is black" },
              { id: "panel_still_not_on_after_power", label: "Still not on after checking power" },
              { id: "bad_date_time", label: "Date/time are not correct" }
            ]
          },
          intents: [
            { id: "panel_not_on", response: "Please check that the small white power box below the panel is plugged in, and that both wires are connected securely." },
            { id: "panel_still_not_on_after_power", response: () => powerCycleForPanel(state.panel_type) },
            { id: "bad_date_time", response: () => `Let‚Äôs reboot the panel:\n\n${rebootForPanel(state.panel_type)}` }
          ]
        },
        {
          id: "step_2",
          name: "Register the panel",
          message: () => {
            const rc = (state.registration_code || "{{registration_code}}");
            return `Tap the 3 dots (bottom-right) ‚Üí Software Version.
When prompted, enter 2203.
Tap ‚ÄúRegister Panel‚Äù and enter this registration code WITHOUT dashes:

${stripDashes(rc)}

When ‚ÄúRegistering‚Äù goes away, tap Done.`;
          },
          ui: {
            issues: [
              { id: "sim_status_too_old", label: "SIM status is too old" },
              { id: "dns_error", label: "DNS error / time not synced" },
              { id: "no_phone_number", label: "No phone number found" },
              { id: "vivint_services_no_response", label: "Vivint services did not respond" },
              { id: "code_2203_failed", label: "2203 didn‚Äôt work" },
              { id: "no_register_panel", label: "I don‚Äôt see ‚ÄúRegister Panel‚Äù" }
            ]
          },
          intents: [
            { id: "sim_status_too_old", response: "Tap Back twice ‚Üí Monitoring and Cellular ‚Üí scroll to the bottom ‚Üí Advanced Cellular Status ‚Üí scroll to the bottom ‚Üí Reset Cellular Module. Then tap Back twice and try registering again." },
            { id: "dns_error", response: () => `Let‚Äôs reboot the panel:\n\n${rebootForPanel(state.panel_type)}` },
            { id: "no_phone_number", response: () => `Let‚Äôs reboot the panel:\n\n${rebootForPanel(state.panel_type)}` },
            { id: "vivint_services_no_response", response: () => `Let‚Äôs reboot the panel:\n\n${rebootForPanel(state.panel_type)}` },
            { id: "no_register_panel", response: "Tap ‚ÄúMonitoring and Cellular‚Äù ‚Üí scroll down ‚Üí tap ‚ÄúUnregister Panel‚Äù ‚Üí tap ‚ÄúUnregister‚Äù. Tap Back and ‚ÄúRegister Panel‚Äù should appear." },
            { id: "code_2203_failed", response: () => `Tap Cancel. Please share the Service Number (top-right), then reboot the panel:\n\n${rebootForPanel(state.panel_type)}\n\nAfter it reboots, we‚Äôll try again.` }
          ]
        },
        {
          id: "step_3",
          name: "Two-Way Voice Test",
          message: () => {
            const csid = state.csid || "{{csid}}";
            return `Tap ‚ÄúSystem Testing‚Äù ‚Üí scroll down ‚Üí tap ‚ÄúTwo-Way Voice Test‚Äù.
To START the test, tap ‚ÄúTwo-Way Voice Test‚Äù one more time (or tap Start Test).

When the voice finishes and it beeps, clearly say: ‚ÄúCORRECT CSID‚Äù.

Then tap Done and tell me what happens.

CSID (if asked): ${csid}`;
          },
          ui: {
            issues: [
              { id: "in_call_or_waiting_no_voice_kicks_out", label: "In Call / Waiting for Status (no voice), then it kicks out" },
              { id: "not_ready_for_test", label: "Not ready for test" },
              { id: "failed_to_initialize", label: "Failed to initialize" },
              { id: "dialing_then_ends", label: "Dialing then ends/hangs up" },
              { id: "waiting_for_status", label: "Stuck on waiting for status" },
              { id: "operator_never_spoke", label: "Operator never spoke" }
            ]
          },
          intents: [
            { id: "in_call_or_waiting_no_voice_kicks_out", response: () => escalate("Two-way test: In Call/Waiting for Status (no voice) then kick out") },
            { id: "not_ready_for_test", response: () => `Tap Back twice ‚Üí Monitoring and Cellular ‚Üí Advanced Cellular Status ‚Üí Reset Cellular Module. Then try the Two-Way Voice Test again. If it still says ‚ÄúNot ready for test,‚Äù reboot:\n\n${rebootForPanel(state.panel_type)}` },
            { id: "failed_to_initialize", response: "Tap Back. Turn ON Test Mode for 10 seconds, then turn it OFF. Try the Two-Way Voice Test again." },
            { id: "dialing_then_ends", response: "Tap Back twice ‚Üí Monitoring and Cellular ‚Üí Advanced Cellular Status ‚Üí Reset Cellular Module. Then try the Two-Way Voice Test again." },
            { id: "waiting_for_status", response: () => `If it stays stuck for a while, reboot:\n\n${rebootForPanel(state.panel_type)}\n\nAfter reboot, try the Two-Way Voice Test again.` },
            { id: "operator_never_spoke", response: "Tap Back twice ‚Üí Monitoring and Cellular ‚Üí Advanced Cellular Status ‚Üí Reset Cellular Module. Then try the Two-Way Voice Test again." }
          ]
        },
        {
          id: "step_4",
          name: "Set up PIN (and Users menu)",
          message: () => `Set up your PIN:

1) Tap the 3 dots (bottom-right)
2) Tap Users
3) If it asks for a code, enter 2203
4) Tap your name
5) Tap the existing PIN
6) Type your new 4-digit PIN ‚Üí tap Save
7) Re-enter the new PIN ‚Üí tap Save

When that‚Äôs done, tap Done.`,
          ui: {
            issues: [
              { id: "cant_find_users", label: "I can‚Äôt find Users" },
              { id: "2203_didnt_work_here", label: "2203 didn‚Äôt work here" },
              { id: "pin_save_failed", label: "It won‚Äôt let me save / error saving PIN" },
              { id: "updating_user_pin_stuck", label: "Stuck on updating user PIN" }
            ]
          },
          intents: [
            { id: "cant_find_users", response: "That‚Äôs okay. Tap Back until you‚Äôre on the Home Screen, then tap the 3 dots (bottom-right) and select Users." },
            { id: "2203_didnt_work_here", response: () => escalate("2203 failed at Users/PIN screen") },
            { id: "pin_save_failed", response: "Try the PIN again. If it still fails, back out, reboot the panel, then try again." },
            { id: "updating_user_pin_stuck", response: "Tap ‚ÄúStop‚Äù, then tap the X. Your new PIN should still be saved." }
          ]
        },
        {
          id: "step_5",
          name: "Panic + Arming test",
          message: () => `Now we‚Äôll test Panic and Arming.

Panic test:
1) Tap the white plus/cross icon at the bottom
2) Press and hold PANIC for 2 seconds
3) Enter 2580 to disarm (or your personal PIN if needed)
4) Tap the X (top-right) to exit ‚ÄúRecent Alarms‚Äù

Arming test:
1) Tap ‚ÄúDisarmed‚Äù
2) Slide left into Stay mode
3) Disarm by dragging down and entering your 4-digit PIN

When finished, tap Done.`,
          ui: {
            issues: [
              { id: "will_this_sound", label: "Will this be loud / sound the alarm?" },
              { id: "duress_not_working", label: "2580 isn‚Äôt working to disarm" },
              { id: "not_ready_to_arm", label: "System says not ready to arm" }
            ]
          },
          intents: [
            { id: "will_this_sound", response: "If the Sounder is off, it should not be loud." },
            { id: "duress_not_working", response: "That‚Äôs okay ‚Äî just use your personal PIN to disarm for now." },
            { id: "not_ready_to_arm", response: "That‚Äôs okay ‚Äî you can tap ‚ÄúArm Anyway‚Äù and enter your PIN. We can fix the warning later." }
          ]
        },
        {
          id: "step_6",
          name: "Emergency contact + verbal password",
          message: () => `Last step ‚Äî choose what you want to do next:
‚Ä¢ Add Emergency Contact
‚Ä¢ Set Verbal Password
‚Ä¢ App Invite

Or tap Done if you‚Äôre finished.`,
          ui: {
            issues: [
              { id: "collect_emergency_contact", label: "Add emergency contact" },
              { id: "verbal_password_info", label: "What is a verbal password?" },
              { id: "app_invite_instructions", label: "Help with app invite" }
            ]
          },
          intents: [
            { id: "collect_emergency_contact", response: "Please share the first name, last name, and phone number for an emergency contact." },
            { id: "verbal_password_info", response: "A verbal password is a word or number you say if we call during an alarm to confirm you‚Äôre safe." },
            { id: "app_invite_instructions", response: "Tap the 3 dots (bottom-right) ‚Üí Users ‚Üí select your name. Enter your phone number and email address, then tap ‚ÄúSend invitation.‚Äù" }
          ]
        }
      ]
    };

    /** ===== Panel-specific helpers ===== */
    function smartHubReboot2Min() {
      return `Slide the panel straight up off the wall. Remove the battery from the back, wait 10 seconds, then put the battery back in and place the panel back on the wall. It should say ‚ÄúYour system is rebooting.‚Äù This usually takes about 2 minutes. Let me know when it finishes and you‚Äôre back on the main screen.`;
    }
    function skyControlReboot5to10() {
      return `Tap the Home button (bottom-right) ‚Üí tap the 3 dots ‚Üí General ‚Üí enter 2203 (or your code if you have one) ‚Üí scroll down ‚Üí tap Reboot. You should see ‚ÄúConnecting Services.‚Äù This reboot usually takes 5‚Äì10 minutes. Let me know when it finishes and you‚Äôre back on the main screen.`;
    }
    function rebootForPanel(panelType) { return (panelType === "skycontrol") ? skyControlReboot5to10() : smartHubReboot2Min(); }
    function powerCycleForPanel(panelType) {
      if (panelType === "skycontrol") return `Please do a reboot (do not slide the panel off the wall):\n\n${skyControlReboot5to10()}`;
      return `Slide the panel straight up off the wall. Make sure the battery is fully seated on the back of the panel. Place the panel back on the wall and make sure it clicks into place.`;
    }

    /** ===== Lost guidance (step-specific) ===== */
    function homeReturnInstruction(panelType) {
      // exactly as you specified
      if (panelType === "skycontrol") return "Tap the House/Home button at the bottom-right.";
      return "Tap the X inside of the shield in the bottom-left.";
    }

    function lostTextForStep(stepId) {
      const home = homeReturnInstruction(state.panel_type);

      if (stepId === "step_1") {
        return `If you‚Äôre on the wrong screen:

1) ${home}

Once you‚Äôre back on the main screen, check the date/time (top-left), then tap Done here.`;
      }

      if (stepId === "step_2") {
        return `If you‚Äôre on the wrong screen:

1) ${home}
2) Tap the 3 dots
3) Tap Software Version
4) Enter 2203

Once you‚Äôre in, continue with registration, then tap Done here.`;
      }

      if (stepId === "step_3") {
        return `If you‚Äôre on the wrong screen:

1) ${home}
2) Tap the 3 dots
3) Tap Software Version
4) Enter 2203
5) Tap System Testing
6) Scroll down and tap Two-Way Voice Test
7) Tap Two-Way Voice Test again (or tap Start Test)
8) When it beeps, say: ‚ÄúCORRECT CSID‚Äù

Then tap Done here.`;
      }

      if (stepId === "step_4") {
        return `If you‚Äôre on the wrong screen:

1) ${home}
2) Tap the 3 dots
3) Tap Software Version
4) Enter 2203
5) Tap System Testing
6) Make sure the Sounder switch is gray/black (OFF)
7) Tap Back twice
8) Tap Users

Then continue with the PIN steps, and tap Done here when finished.`;
      }

      if (stepId === "step_5") {
        return `If you‚Äôre on the wrong screen:

1) ${home}
2) Tap the white plus sign / cross symbol at the bottom

Then continue the Panic test and tap Done here when finished.`;
      }

      // Step 6: keep it simple
      return `If you‚Äôre on the wrong screen:

1) ${home}
2) Tap the 3 dots ‚Üí Users

Then continue and tap Done here when finished.`;
    }

    /** ====== State ====== */
    function defaultState() {
      return {
        current_step_id: "step_1",
        panel_type: "",
        csid: "",
        registration_code: "",
        service_number: "",
        history: ["step_1"],
        // Used to restore the step message after "Issue" or "Lost"
        return_step_id: "step_1",
        return_step_message: "",
        // When true, DONE returns to the step message instead of advancing
        pending_return_to_step_on_done: false
      };
    }

    let state = loadState() || defaultState();
    const escalationDefault = `Thanks ‚Äî I‚Äôm going to bring in a team member to help you from here.`;

    /** ====== UI elements ====== */
    const botMessageEl = document.getElementById("botMessage");
    const stepPill = document.getElementById("stepPill");
    const panelPill = document.getElementById("panelPill");
    const issuesMenuEl = document.getElementById("issuesMenu");
    const statusLine = document.getElementById("statusLine");
    const helperPanel = document.getElementById("helperPanel");
    const csidInput = document.getElementById("csid");
    const regInput = document.getElementById("reg");
    const serviceInput = document.getElementById("serviceNum");
    const panelSelect = document.getElementById("panelSelect");
    const overlay = document.getElementById("overlay");

    const csidOnlyText = document.getElementById("csidOnlyText");
    const copyCsidBtn = document.getElementById("copyCsidBtn");

    const escalationTextEl = document.getElementById("escalationText");
    escalationTextEl.value = escalationDefault;

    const makeLinkBtn = document.getElementById("makeLinkBtn");
    const copyLinkBtn = document.getElementById("copyLinkBtn");
    const shareLinkInput = document.getElementById("shareLink");

    /** ====== Helpers ====== */
    function getStep(stepId) { return FLOW.steps.find(s => s.id === stepId); }
    function setStatus(msg) { statusLine.textContent = msg || ""; }
    function escapeHtml(s) {
      return (s||"").replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
    }
    function showInfo(msg) { helperPanel.innerHTML = `<div class="ok">${escapeHtml(msg).replace(/\n/g,"<br>")}</div>`; }
    function showAlert(msg) { helperPanel.innerHTML = `<div class="alert">${escapeHtml(msg).replace(/\n/g,"<br>")}</div>`; }
    function clearHelper() { helperPanel.innerHTML = ""; }
    function saveState() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
    function loadState() { try { return JSON.parse(localStorage.getItem(STORAGE_KEY)); } catch { return null; } }
    function setOverlay(open) { overlay.classList.toggle("open", !!open); }
    function withLoading(fn, delayMs = 250) {
      setOverlay(true);
      setTimeout(() => { try { fn(); } finally { setOverlay(false); } }, delayMs);
    }

    function interpolateStepMessage(step) {
      let msg = typeof step.message === "function" ? step.message() : step.message;
      msg = msg.replace(/\{\{csid\}\}/g, state.csid || "{{csid}}");
      msg = msg.replace(/\{\{registration_code\}\}/g, state.registration_code || "{{registration_code}}");
      return msg;
    }

    function gotoStep(stepId) {
      state.current_step_id = stepId;
      state.history.push(stepId);
      saveState();
      render();
    }

    function goBackOneStep() {
      if (state.history.length <= 1) return;
      state.history.pop();
      state.current_step_id = state.history[state.history.length - 1];
      saveState();
      render();
    }

    function escalate(reason) {
      const esc = escalationTextEl.value || escalationDefault;
      setStatus(`Help requested: ${reason}`);
      return esc;
    }

    /** ====== Issue flow: show fix, then DONE returns to step message ====== */
    function openTempMessageThenReturnOnDone(tempMessage) {
      const step = getStep(state.current_step_id);
      state.return_step_id = state.current_step_id;
      state.return_step_message = step ? interpolateStepMessage(step) : "";
      state.pending_return_to_step_on_done = true;
      saveState();

      botMessageEl.textContent = tempMessage;
      showInfo("After you try that, tap Done to return to the step.");
    }

    function handleIntent(intentId) {
      const step = getStep(state.current_step_id);
      const intent = step?.intents?.find(i => i.id === intentId);
      if (!intent) { showAlert("No message found for that option."); return; }

      let response = intent.response;
      if (typeof response === "function") response = response();

      openTempMessageThenReturnOnDone(response);
    }

    /** ====== Lost button: step-specific generic return path ====== */
    function handleLost() {
      const txt = lostTextForStep(state.current_step_id);
      openTempMessageThenReturnOnDone(txt);
    }

    /** ===== Customer Prefill + Customer Mode ===== */
    function encodeB64Url(str) {
      return btoa(unescape(encodeURIComponent(str)))
        .replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/g, "");
    }
    function decodeB64Url(b64url) {
      const b64 = b64url.replace(/-/g, "+").replace(/_/g, "/") + "===".slice((b64url.length + 3) % 4);
      return decodeURIComponent(escape(atob(b64)));
    }
    function buildShareLinkFromState() {
      const payload = {
        panel: state.panel_type || "",
        csid: state.csid || "",
        reg: state.registration_code || "",
        service: state.service_number || ""
      };
      const packed = encodeB64Url(JSON.stringify(payload));
      const base = `${location.origin}${location.pathname}`;
      return `${base}#prefill=${packed}`;
    }

    function applyCustomerMode() {
      isCustomerMode = true;
      document.body.classList.add("customerMode");
      panelSelect.disabled = true;
      csidInput.readOnly = true;
      regInput.readOnly = true;
      serviceInput.readOnly = true;

      // Customers always start at step_1
      state.current_step_id = "step_1";
      state.history = ["step_1"];
      saveState();
    }

    function applyPrefill(payload) {
      if (payload.panel) state.panel_type = String(payload.panel).toLowerCase();
      if (payload.csid) state.csid = String(payload.csid).trim();
      if (payload.reg) state.registration_code = String(payload.reg).trim();
      if (payload.service) state.service_number = String(payload.service).trim();
      state.current_step_id = "step_1";
      state.history = ["step_1"];
      saveState();
      applyCustomerMode();
    }

    function tryPrefillFromUrl() {
      const hash = location.hash || "";
      const m = hash.match(/prefill=([^&]+)/);
      if (m && m[1]) {
        try {
          const payload = JSON.parse(decodeB64Url(m[1]));
          applyPrefill(payload);
          return true;
        } catch {}
      }
      return false;
    }

    /** ====== Rendering ====== */
    function render() {
      const step = getStep(state.current_step_id) || getStep("step_1");
      if (!getStep(state.current_step_id)) {
        state.current_step_id = "step_1";
        state.history = ["step_1"];
        saveState();
      }

      const panelLabel = state.panel_type
        ? (state.panel_type === "skycontrol" ? "SkyControl" : "SmartHub")
        : "Not set";

      panelPill.textContent = panelLabel;
      stepPill.textContent = `${step?.id || "‚Äî"} ‚Ä¢ ${step?.name || ""}`;

      panelSelect.value = state.panel_type || "";
      csidInput.value = state.csid || "";
      regInput.value = state.registration_code || "";
      serviceInput.value = state.service_number || "";

      csidOnlyText.textContent = state.csid ? state.csid : "‚Äî";

      // If we are not currently showing a temp message, ensure step message is visible.
      // (If temp message is showing, we keep it until user taps Done.)
      if (!state.pending_return_to_step_on_done) {
        const msg = step ? interpolateStepMessage(step) : "Step not found.";
        botMessageEl.textContent = msg;
      }

      buildIssuesMenu(step);

      if (isCustomerMode) {
        clearHelper();
      } else {
        if (!state.panel_type) setStatus("Agent: choose panel type on the right before generating a customer link.");
        else setStatus("");
      }
    }

    function buildIssuesMenu(step) {
      issuesMenuEl.innerHTML = "";
      if (!step?.ui?.issues?.length) return;

      const title = document.createElement("div");
      title.className = "muted small";
      title.style.marginBottom = "8px";
      title.textContent = "Choose the issue you‚Äôre seeing:";
      issuesMenuEl.appendChild(title);

      step.ui.issues.forEach(item => {
        const btn = document.createElement("button");
        btn.textContent = item.label;
        btn.onclick = () => withLoading(() => {
          handleIntent(item.id);
          issuesMenuEl.classList.remove("open");
        }, 200);
        issuesMenuEl.appendChild(btn);
      });
    }

    /** ====== Button handlers ====== */
    document.getElementById("doneBtn").onclick = () => withLoading(() => {
      // If we are returning from an Issue/Lost message, DONE returns to step message (no step advance)
      if (state.pending_return_to_step_on_done) {
        const step = getStep(state.return_step_id || state.current_step_id);
        const restore = state.return_step_message || (step ? interpolateStepMessage(step) : "");
        state.pending_return_to_step_on_done = false;
        saveState();

        botMessageEl.textContent = restore || (step ? interpolateStepMessage(step) : botMessageEl.textContent);
        showInfo("Back to the step. When you finish the step, tap Done again to continue.");
        return;
      }

      // Normal DONE: advance to next step
      const idx = FLOW.steps.findIndex(s => s.id === state.current_step_id);
      if (idx < 0) { state.current_step_id = "step_1"; state.history = ["step_1"]; saveState(); render(); return; }
      const next = FLOW.steps[idx + 1];
      if (!next) { showInfo("All set ‚Äî you‚Äôre finished."); return; }
      gotoStep(next.id);
    }, 250);

    document.getElementById("issuesBtn").onclick = () => {
      const step = getStep(state.current_step_id);
      if (!step) return;
      issuesMenuEl.classList.toggle("open");
    };

    document.getElementById("lostBtn").onclick = () => withLoading(() => {
      handleLost();
      issuesMenuEl.classList.remove("open");
    }, 200);

    document.getElementById("escalateBtn").onclick = () => withLoading(() => {
      // As requested: simple contact instruction
      state.pending_return_to_step_on_done = false; // don't trap DONE
      saveState();
      botMessageEl.textContent = "To chat with a representative, text (385) 425-0752)";
      showAlert("If you already texted and need to keep going, you can continue with the steps above.");
    }, 200);

    document.getElementById("copyBtn").onclick = async () => {
      try { await navigator.clipboard.writeText(botMessageEl.textContent); setStatus("Copied."); }
      catch { setStatus("Copy failed (browser permissions)."); }
    };

    document.getElementById("copyEscBtn").onclick = async () => {
      try { await navigator.clipboard.writeText(escalationTextEl.value); setStatus("Copied escalation message."); }
      catch { setStatus("Copy failed (browser permissions)."); }
    };

    document.getElementById("backBtn").onclick = () => withLoading(() => goBackOneStep(), 200);

    document.getElementById("resetBtn").onclick = () => withLoading(() => {
      localStorage.removeItem(STORAGE_KEY);
      state = defaultState();
      isCustomerMode = false;
      document.body.classList.remove("customerMode");
      botMessageEl.textContent = interpolateStepMessage(getStep("step_1"));
      render();
      showInfo("Reset complete.");
    }, 200);

    panelSelect.onchange = (e) => { state.panel_type = e.target.value; saveState(); render(); };
    csidInput.oninput = (e) => { state.csid = e.target.value.trim(); saveState(); render(); };
    regInput.oninput = (e) => { state.registration_code = e.target.value.trim(); saveState(); render(); };
    serviceInput.oninput = (e) => { state.service_number = e.target.value.trim(); saveState(); };

    copyCsidBtn.onclick = async () => {
      try { await navigator.clipboard.writeText(state.csid || ""); setStatus("CSID copied."); }
      catch { setStatus("Copy failed (browser permissions)."); }
    };

    makeLinkBtn.onclick = () => {
      const url = buildShareLinkFromState();
      shareLinkInput.value = url;
      copyLinkBtn.disabled = false;
      setStatus("Link generated.");
    };

    copyLinkBtn.onclick = async () => {
      try { await navigator.clipboard.writeText(shareLinkInput.value); setStatus("Link copied."); }
      catch { setStatus("Copy failed (browser permissions)."); }
    };

    /** ====== Init ====== */
    const wasPrefilled = tryPrefillFromUrl();

    // If NOT prefilled, ensure we still start at step_1
    if (!wasPrefilled) {
      if (!state.current_step_id || !getStep(state.current_step_id)) {
        state.current_step_id = "step_1";
        state.history = ["step_1"];
        saveState();
      }
    }

    // Ensure initial message is step message
    state.pending_return_to_step_on_done = false;
    saveState();
    render();
  </script>
</body>
</html>
